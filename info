# üìã Documentation Technique - FeedActu

## üèóÔ∏è **Architecture G√©n√©rale**

**FeedActu** est une application React de gestion de contenu multi-r√©sidences d√©velopp√©e pour UXCO. Elle permet aux gestionnaires de publier diff√©rents types de contenus (posts, √©v√©nements, sondages, alertes, messages quotidiens) dans plusieurs r√©sidences simultan√©ment.

### **Stack Technique**
- **Frontend**: React 18 + Material-UI (MUI) v7
- **Authentification**: Microsoft Azure AD (MSAL)
- **Base de donn√©es**: PostgreSQL (via sch√©mas JSON)
- **Routage**: React Router v7
- **√âditeur**: Draft.js (WYSIWYG)
- **Calendrier**: FullCalendar
- **Validation**: Zod + Sch√©mas JSON personnalis√©s

---

## üìù **SCH√âMAS COMPLETS DES PUBLICATIONS** ‚ö†Ô∏è **R√âF√âRENCE D√âFINITIVE**

### **üîπ 1. POSTS (Articles/Informations)**
```javascript
fields: [
  { name: 'title', label: 'Titre', type: 'text', required: true },
  { name: 'message', label: 'Message', type: 'wysiwyg', required: true },
  { name: 'imageUrl', label: 'Image', type: 'image', required: false, 
    helperText: 'Chargez un fichier ou collez une URL d\'image' },
  { name: 'category', label: 'Cat√©gorie', type: 'select', required: false,
    options: [
      { value: 'info', label: 'Information' },
      { value: 'maintenance', label: 'Maintenance' },
      { value: 'community', label: 'Vie communautaire' },
      { value: 'security', label: 'S√©curit√©' },
      { value: 'other', label: 'Autre' }
    ]
  }
]
// + R√©sidence(s) + Publier plus tard + Date/heure publication ult√©rieure
```

### **üîπ 2. SONDAGES (Polls)**
```javascript
fields: [
  { name: 'question', label: 'Question du sondage', type: 'text', required: true },
  { name: 'pollAnswers', label: 'R√©ponses possibles', type: 'pollAnswers', required: true },
  { name: 'allowMultiple', label: 'Autoriser plusieurs r√©ponses', type: 'checkbox', required: false },
  { name: 'deadline', label: 'Date limite de r√©ponse', type: 'datetime', required: false },
  { name: 'imageUrl', label: 'Image du sondage', type: 'image', required: false,
    helperText: 'Chargez un fichier ou collez une URL d\'image' }
]
// + R√©sidence(s) + Publier plus tard + Date/heure publication ult√©rieure
```

### **üîπ 3. √âV√âNEMENTS (Events)**
```javascript
fields: [
  { name: 'title', label: 'Titre de l\'√©v√©nement', type: 'text', required: true },
  { name: 'description', label: 'Description', type: 'wysiwyg', required: true },
  { name: 'eventDateRange', label: 'Date et heure de l\'√©v√©nement', type: 'daterange', required: true,
    disablePast: true, helperText: 'S√©lectionnez les dates et heures de d√©but et de fin' },
  { name: 'location', label: 'Lieu', type: 'text', required: true },
  { name: 'maxParticipants', label: 'Nombre max de participants', type: 'number', required: false },
  { name: 'imageUrl', label: 'Image de l\'√©v√©nement', type: 'image', required: false,
    helperText: 'Chargez un fichier ou collez une URL d\'image' }
]
// + R√©sidence(s) + Publier plus tard + Date/heure publication ult√©rieure
```

### **üîπ 4. MESSAGES DU JOUR (Daily Messages)**
```javascript
fields: [
  { name: 'title', label: 'Titre du message', type: 'text', required: true },
  { name: 'message', label: 'Message du jour', type: 'wysiwyg', required: true }
]
// + R√©sidence(s) + Publier plus tard + Date/heure publication ult√©rieure
```

### **üîπ 5. ALERTES (Alerts)** ‚ö†Ô∏è **√Ä CORRIGER**
```javascript
fields: [
  { name: 'alertType', label: 'Type d\'alerte', type: 'select', required: true,
    options: [
      { value: 'maintenance', label: 'Maintenance' },
      { value: 'security', label: 'S√©curit√©' },
      { value: 'emergency', label: 'Urgence' },
      { value: 'service', label: 'Service' },
      { value: 'weather', label: 'M√©t√©o' },
      { value: 'other', label: 'Autre' }
    ]
  },
  { name: 'message', label: 'Message d\'alerte', type: 'wysiwyg', required: true }
]
// + R√©sidence(s) + Publier plus tard + Date/heure publication ult√©rieure
```

### **üîß CHAMPS COMMUNS √Ä TOUS LES TYPES**
```javascript
// Automatiquement ajout√©s par le syst√®me :
commonFields: [
  // S√©lection des r√©sidences (obligatoire)
  { name: 'targetResidences', type: 'residence-selector', required: true },
  
  // Publication diff√©r√©e (optionnel)
  { name: 'publishLater', label: 'Publier plus tard', type: 'checkbox', required: false },
  { name: 'publishDateTime', label: 'Date et heure de publication', type: 'datetime', 
    required: false, showIf: 'publishLater' }
]
```

### **üéØ TYPES DE CHAMPS SUPPORT√âS**
- `text` : Champ texte simple
- `wysiwyg` : √âditeur riche (HTML)
- `image` : Upload fichier OU URL (hybride)
- `select` : Liste d√©roulante avec options
- `checkbox` : Case √† cocher
- `number` : Champ num√©rique
- `datetime` : S√©lecteur date/heure
- `daterange` : Deux DateTimePicker (d√©but/fin)
- `pollAnswers` : Gestion dynamique des r√©ponses de sondage

### **‚úÖ CORRECTIONS APPLIQU√âES (D√©cembre 2024)**

**üîß Alertes** - Champs corrig√©s selon sch√©ma de r√©f√©rence :
- ‚ùå Ancien : `message` (richtext) + `type` + `priority`
- ‚úÖ Nouveau : `alertType` (select) + `message` (wysiwyg)

**üîß Posts** - Cat√©gories standardis√©es :
- ‚ùå Ancien : `info`, `event`, `urgent`
- ‚úÖ Nouveau : `info`, `maintenance`, `community`, `security`, `other`

**üîß Sondages** - Simplification des champs :
- ‚ùå Ancien : `question` (wysiwyg) + `allowMultipleAnswers` + `hasDeadline` + `deadlineDate` (conditionnel)
- ‚úÖ Nouveau : `question` (text) + `allowMultiple` + `deadline` (datetime direct)

**üîß Messages du jour** - Harmonisation des noms :
- ‚ùå Ancien : `content` (richtext)
- ‚úÖ Nouveau : `message` (wysiwyg)

**üîß √âv√©nements** - D√©j√† conformes au sch√©ma ‚úÖ

---

## üéØ **Fonctionnalit√©s Principales**

### **1. Syst√®me d'Authentification Multi-Tenant**
üìç **Localisation**: `src/context/AuthContext.js`, `src/hooks/useAuth.js`

**Fonctionnement**:
- Authentification via Microsoft Azure AD avec MSAL
- Gestion multi-tenant (plusieurs organisations)
- Token JWT avec rafra√Æchissement automatique
- Session persistante via localStorage
- Mapping utilisateur-r√©sidences

**S√©curit√©**:
- 5 niveaux de validation de s√©curit√©
- Contr√¥le d'acc√®s par r√©sidence
- Logs d'audit pour tentatives suspectes
- Protection contre l'escalade de privil√®ges

**Interactions**:
- Interface avec `ResidenceContext` pour la s√©lection de r√©sidence
- Middleware d'authentification pour toutes les actions sensibles
- Int√©gration Microsoft Graph pour profils utilisateurs

---

### **2. Gestion Multi-R√©sidences**
üìç **Localisation**: `src/context/ResidenceContext.js`, `src/userResidenceMapping.js`

**Fonctionnement**:
- Syst√®me de mapping email ‚Üí r√©sidences autoris√©es
- S√©lection de r√©sidence active
- Publication cibl√©e multi-r√©sidences
- Filtrage automatique par r√©sidence

**Composants Cl√©s**:
- `ResidenceTagSelector`: S√©lection multi-r√©sidences avec validation
- `ResidenceSelector`: Changement de r√©sidence active
- `ResidenceMultiSelector`: Interface pour publications

**D√©pendances**:
- Requiert authentification pr√©alable
- Synchronis√© avec le contexte d'authentification
- Valide les permissions utilisateur

---

### **3. Syst√®me de Publication Unifi√©**
üìç **Localisation**: `src/components/ModalPublicationForm.js`

**Types de Publications**:
1. **Posts** - Articles et informations g√©n√©rales
2. **Events** - √âv√©nements avec calendrier int√©gr√©
3. **Polls** - Sondages avec choix multiples
4. **Alerts** - Alertes urgentes
5. **Daily Messages** - Messages quotidiens

**Fonctionnalit√©s**:
- Interface unifi√©e pour tous types
- √âditeur WYSIWYG int√©gr√©
- Publication imm√©diate ou programm√©e
- Aper√ßu mobile en temps r√©el
- Validation multi-niveaux

**Workflow**:
1. S√©lection des r√©sidences cibles (s√©curis√©e)
2. Saisie du contenu avec validation
3. Aper√ßu optionnel
4. Publication ou sauvegarde en brouillon

---

### **4. Dashboard Analytics**
üìç **Localisation**: `src/pages/Dashboard.js`

**M√©triques Affich√©es**:
- Statistiques de publication par type
- Activit√© r√©cente
- Actions rapides
- Tendances par r√©sidence

**Widgets**:
- Cartes statistiques avec tendances
- Timeline d'activit√© r√©cente
- Boutons d'actions rapides
- Graphiques de performance

---

### **5. Calendrier Int√©gr√©**
üìç **Localisation**: `src/pages/EventsCalendar.js`

**Fonctionnalit√©s**:
- Vue mensuelle/hebdomadaire/quotidienne
- Filtrage par r√©sidence
- Cr√©ation d'√©v√©nements par glisser-d√©poser
- Gestion des participants
- Export iCal

**Int√©grations**:
- Synchronis√© avec la gestion d'√©v√©nements
- Filtres dynamiques par r√©sidence
- Interface responsive

---

## üîß **Composants Techniques**

### **Gestion d'Erreurs Robuste**
üìç **Localisation**: `src/utils/errorHandler.js`

**Fonctionnalit√©s**:
- Retry automatique avec backoff exponentiel
- Sauvegarde locale en cas d'√©chec
- Messages d'erreur contextuels
- Logs d√©taill√©s pour debugging

### **Syst√®me de Logs**
üìç **Localisation**: `src/utils/publicationLogger.js`

**Capacit√©s**:
- Logging complet des publications
- Tra√ßabilit√© des actions utilisateur
- M√©triques de performance
- Audit de s√©curit√©

### **Composants UI R√©utilisables**
- `DataTable`: Table avec tri, recherche, pagination
- `PageHeader`: En-t√™tes de pages avec breadcrumbs
- `RichTextEditor`: √âditeur WYSIWYG personnalis√©
- `MobilePreview`: Aper√ßu mobile des publications

---

## üîê **S√©curit√© et Validation**

### **Niveaux de S√©curit√©**
1. **Authentification pr√©alable** - V√©rification MSAL
2. **Autorisation r√©sidence** - Mapping utilisateur-r√©sidences
3. **Validation interface** - Contr√¥les client-side
4. **Validation dynamique** - V√©rifications temps r√©el
5. **Validation finale** - Double contr√¥le avant soumission

### **Sch√©mas de Validation**
üìç **Localisation**: `schemas/`
- JSON Schema pour chaque type de publication
- Validation c√¥t√© client et pr√©paration serveur
- Contraintes de s√©curit√© int√©gr√©es

---

## üèóÔ∏è **Base de Donn√©es**

### **Architecture PostgreSQL**
üìç **Localisation**: `schemas/creation.sql`

**Tables Principales**:
- `posts`, `events`, `polls`, `alerts`, `daily_messages`
- `user_profiles`, `event_participants`
- `post_reactions`, `poll_votes`
- Syst√®me de vues et statistiques en cache

**Optimisations**:
- Index partiels pour performance
- Triggers pour mise √† jour automatique
- Fonctions PL/pgSQL pour requ√™tes complexes
- Cache mat√©rialis√© pour analytics

---

## üîÑ **Flux de Donn√©es**

### **Cycle de Vie d'une Publication**
1. **Authentification** ‚Üí V√©rification utilisateur
2. **S√©lection R√©sidences** ‚Üí Validation autorisations
3. **Saisie Contenu** ‚Üí Validation formulaire
4. **Pr√©visualisation** ‚Üí G√©n√©ration aper√ßu
5. **Publication** ‚Üí Sauvegarde + Logs
6. **Distribution** ‚Üí Filtrage par r√©sidence

### **Interactions Composants**
```
AuthContext ‚Üê‚Üí ResidenceContext
     ‚Üì              ‚Üì
   useAuth ‚Üê‚Üí useResidence
     ‚Üì              ‚Üì
ModalPublicationForm ‚Üê‚Üí ResidenceTagSelector
     ‚Üì
PublicationLogger + ErrorHandler
```

---

## üöÄ **Extensions Pr√©vues**

### **‚úÖ R√©cemment Impl√©ment√©**
- **Contexte de Publications Persistant** : Sauvegarde automatique locale + sync serveur transparente
- **Auto-sauvegarde des Brouillons** : Restauration automatique apr√®s 24h
- **Mode Hors-ligne Intelligent** : Cr√©ation continue m√™me sans connexion
- **Gestion d'Images Hybride** : Upload de fichier OU URL au choix
- **Interface Date/Heure Simplifi√©e** : Un seul champ daterange pour les √©v√©nements
- **Gestion Compl√®te des Sondages** : R√©ponses multiples, √©ch√©ances, images

### **Court Terme**
- Validation serveur (actuellement client-side uniquement)
- API REST compl√®te
- Synchronisation automatique en arri√®re-plan

### **Moyen Terme**
- Notifications push
- Templates de publication
- Workflow d'approbation

### **Long Terme**
- Analytics avanc√©s
- IA pour suggestion de contenu
- Application mobile native

---

## üìä **M√©triques et Monitoring**

### **Performance**
- Temps de chargement des pages
- Taux de r√©ussite des publications
- M√©triques d'engagement utilisateur

### **S√©curit√©**
- Tentatives d'acc√®s non autoris√©es
- √âchecs d'authentification
- Violations de permissions

---

## üõ†Ô∏è **Maintenance**

### **Logs √† Surveiller**
- Erreurs d'authentification MSAL
- √âchecs de publication
- Tentatives de s√©lection non autoris√©e

### **Mises √† Jour R√©guli√®res**
- Tokens Azure AD
- Sch√©mas de validation
- Mapping utilisateur-r√©sidences

### **Sauvegarde**
- Publications √©chou√©es (localStorage)
- Sessions utilisateur
- Configuration r√©sidences

---

## üìù **Notes Techniques**

### **Compatibilit√©**
- React 18+ requis
- Material-UI v7 (derni√®re version)
- Node.js 16+ recommand√©

### **Configuration**
- Variables d'environnement pour Azure AD
- Mapping r√©sidences dans `userResidenceMapping.js`
- Th√®mes CSS dans `src/styles/directus-theme.css`

### **Tests**
- Tests unitaires avec Jest
- Tests de s√©curit√© automatis√©s
- Validation des sch√©mas JSON

---

## üîç **Points d'Attention**

### **S√©curit√© Critique**
- Toujours valider les r√©sidences s√©lectionn√©es
- Ne jamais faire confiance aux donn√©es client-side
- Logger toutes les actions sensibles

### **Performance**
- Optimiser les re-renders React
- Utiliser la pagination pour grandes listes
- Cache les donn√©es statiques

### **UX/UI**
- Interface responsive obligatoire
- Feedback utilisateur pour toutes actions
- Messages d'erreur compr√©hensibles

---

---

## üéâ **Derni√®res Am√©liorations - Version 0.2.0**

### **üîÑ Persistance Robuste (NOUVEAU)**
- **PublicationsContext** : Syst√®me hybride local + serveur
- **Auto-sauvegarde** : Brouillons sauv√©s automatiquement pendant la saisie
- **Mode hors-ligne** : Fonctionnement complet sans connexion
- **Synchronisation transparente** : Invisible pour l'utilisateur m√©tier

### **üñºÔ∏è Gestion d'Images Am√©lior√©e (NOUVEAU)**
- **Type 'image'** : Upload de fichier OU saisie d'URL au choix
- **Aper√ßu instantan√©** : Visualisation imm√©diate de l'image s√©lectionn√©e
- **Validation automatique** : V√©rification du format et affichage

### **üìÖ Interface √âv√©nements Simplifi√©e (NOUVEAU)**
- **Type 'daterange'** : Remplacement de 3 champs par 1 seul
- **Validation intelligente** : Date de fin automatiquement apr√®s d√©but
- **UX am√©lior√©e** : Plus simple et intuitif pour l'utilisateur

### **üìä Sondages Complets (CORRIG√â)**
- **Type 'pollAnswers'** : Gestion compl√®te des r√©ponses multiples
- **Conditions dynamiques** : Champs qui apparaissent selon les choix
- **Validation robuste** : Minimum 2 r√©ponses requises

---

**Derni√®re mise √† jour**: D√©cembre 2024  
**Version**: 0.2.0  
**Mainteneur**: √âquipe UXCO
