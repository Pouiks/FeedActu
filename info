# ğŸ“‹ Documentation Technique - FeedActu

## ğŸ—ï¸ **Architecture GÃ©nÃ©rale**

**FeedActu** est une application React de gestion de contenu multi-rÃ©sidences dÃ©veloppÃ©e pour UXCO. Elle permet aux gestionnaires de publier diffÃ©rents types de contenus (posts, Ã©vÃ©nements, sondages, alertes, messages quotidiens) dans plusieurs rÃ©sidences simultanÃ©ment.

### **Stack Technique**
- **Frontend**: React 18 + Material-UI (MUI) v7
- **Authentification**: Microsoft Azure AD (MSAL)
- **Base de donnÃ©es**: PostgreSQL (via schÃ©mas JSON)
- **Routage**: React Router v7
- **Ã‰diteur**: Draft.js (WYSIWYG)
- **Calendrier**: FullCalendar
- **Validation**: Zod + SchÃ©mas JSON personnalisÃ©s

---

## ğŸ“ **SCHÃ‰MAS COMPLETS DES PUBLICATIONS** âš ï¸ **RÃ‰FÃ‰RENCE DÃ‰FINITIVE**

### **ğŸ”¹ 1. POSTS (Articles/Informations)**
```javascript
fields: [
  { name: 'title', label: 'Titre', type: 'text', required: true },
  { name: 'message', label: 'Message', type: 'wysiwyg', required: true },
  { name: 'imageUrl', label: 'Image', type: 'image', required: false, 
    helperText: 'Chargez un fichier ou collez une URL d\'image' },
  { name: 'category', label: 'CatÃ©gorie', type: 'select', required: false,
    options: [
      { value: 'info', label: 'Information' },
      { value: 'maintenance', label: 'Maintenance' },
      { value: 'community', label: 'Vie communautaire' },
      { value: 'security', label: 'SÃ©curitÃ©' },
      { value: 'other', label: 'Autre' }
    ]
  }
]
// + RÃ©sidence(s) + Publier plus tard + Date/heure publication ultÃ©rieure
```

### **ğŸ”¹ 2. SONDAGES (Polls)**
```javascript
fields: [
  { name: 'question', label: 'Question du sondage', type: 'text', required: true },
  { name: 'pollAnswers', label: 'RÃ©ponses possibles', type: 'pollAnswers', required: true },
  { name: 'allowMultiple', label: 'Autoriser plusieurs rÃ©ponses', type: 'checkbox', required: false },
  { name: 'deadline', label: 'Date limite de rÃ©ponse', type: 'datetime', required: false },
  { name: 'imageUrl', label: 'Image du sondage', type: 'image', required: false,
    helperText: 'Chargez un fichier ou collez une URL d\'image' }
]
// + RÃ©sidence(s) + Publier plus tard + Date/heure publication ultÃ©rieure
```

### **ğŸ”¹ 3. Ã‰VÃ‰NEMENTS (Events)**
```javascript
fields: [
  { name: 'title', label: 'Titre de l\'Ã©vÃ©nement', type: 'text', required: true },
  { name: 'description', label: 'Description', type: 'wysiwyg', required: true },
  { name: 'eventDateRange', label: 'Date et heure de l\'Ã©vÃ©nement', type: 'daterange', required: true,
    disablePast: true, helperText: 'SÃ©lectionnez les dates et heures de dÃ©but et de fin' },
  { name: 'location', label: 'Lieu', type: 'text', required: true },
  { name: 'maxParticipants', label: 'Nombre max de participants', type: 'number', required: false },
  { name: 'imageUrl', label: 'Image de l\'Ã©vÃ©nement', type: 'image', required: false,
    helperText: 'Chargez un fichier ou collez une URL d\'image' }
]
// + RÃ©sidence(s) + Publier plus tard + Date/heure publication ultÃ©rieure
```

### **ğŸ”¹ 4. MESSAGES DU JOUR (Daily Messages)**
```javascript
fields: [
  { name: 'title', label: 'Titre du message', type: 'text', required: true },
  { name: 'message', label: 'Message du jour', type: 'wysiwyg', required: true }
]
// + RÃ©sidence(s) + Publier plus tard + Date/heure publication ultÃ©rieure
```

### **ğŸ”¹ 5. ALERTES (Alerts)** âš ï¸ **Ã€ CORRIGER**
```javascript
fields: [
  { name: 'alertType', label: 'Type d\'alerte', type: 'select', required: true,
    options: [
      { value: 'maintenance', label: 'Maintenance' },
      { value: 'security', label: 'SÃ©curitÃ©' },
      { value: 'emergency', label: 'Urgence' },
      { value: 'service', label: 'Service' },
      { value: 'weather', label: 'MÃ©tÃ©o' },
      { value: 'other', label: 'Autre' }
    ]
  },
  { name: 'message', label: 'Message d\'alerte', type: 'wysiwyg', required: true }
]
// + RÃ©sidence(s) + Publier plus tard + Date/heure publication ultÃ©rieure
```

### **ğŸ”§ CHAMPS COMMUNS Ã€ TOUS LES TYPES**
```javascript
// Automatiquement ajoutÃ©s par le systÃ¨me :
commonFields: [
  // SÃ©lection des rÃ©sidences (obligatoire)
  { name: 'targetResidences', type: 'residence-selector', required: true },
  
  // Publication diffÃ©rÃ©e (optionnel)
  { name: 'publishLater', label: 'Publier plus tard', type: 'checkbox', required: false },
  { name: 'publishDateTime', label: 'Date et heure de publication', type: 'datetime', 
    required: false, showIf: 'publishLater' }
]
```

### **ğŸ¯ TYPES DE CHAMPS SUPPORTÃ‰S**
- `text` : Champ texte simple
- `wysiwyg` : Ã‰diteur riche (HTML)
- `image` : Upload fichier OU URL (hybride)
- `select` : Liste dÃ©roulante avec options
- `checkbox` : Case Ã  cocher
- `number` : Champ numÃ©rique
- `datetime` : SÃ©lecteur date/heure
- `daterange` : Deux DateTimePicker (dÃ©but/fin)
- `pollAnswers` : Gestion dynamique des rÃ©ponses de sondage

### **âœ… CORRECTIONS APPLIQUÃ‰ES (DÃ©cembre 2024)**

**ğŸ”§ Alertes** - Champs corrigÃ©s selon schÃ©ma de rÃ©fÃ©rence :
- âŒ Ancien : `message` (richtext) + `type` + `priority`
- âœ… Nouveau : `alertType` (select) + `message` (wysiwyg)

**ğŸ”§ Posts** - CatÃ©gories standardisÃ©es :
- âŒ Ancien : `info`, `event`, `urgent`
- âœ… Nouveau : `info`, `maintenance`, `community`, `security`, `other`

**ğŸ”§ Sondages** - Simplification des champs :
- âŒ Ancien : `question` (wysiwyg) + `allowMultipleAnswers` + `hasDeadline` + `deadlineDate` (conditionnel)
- âœ… Nouveau : `question` (text) + `allowMultiple` + `deadline` (datetime direct)

**ğŸ”§ Messages du jour** - Harmonisation des noms :
- âŒ Ancien : `content` (richtext)
- âœ… Nouveau : `message` (wysiwyg)

**ğŸ”§ Ã‰vÃ©nements** - DÃ©jÃ  conformes au schÃ©ma âœ…

---

## ğŸ¯ **FonctionnalitÃ©s Principales**

### **1. SystÃ¨me d'Authentification Multi-Tenant**
ğŸ“ **Localisation**: `src/context/AuthContext.js`, `src/hooks/useAuth.js`

**Fonctionnement**:
- Authentification via Microsoft Azure AD avec MSAL
- Gestion multi-tenant (plusieurs organisations)
- Token JWT avec rafraÃ®chissement automatique
- Session persistante via localStorage
- Mapping utilisateur-rÃ©sidences

**SÃ©curitÃ©**:
- 5 niveaux de validation de sÃ©curitÃ©
- ContrÃ´le d'accÃ¨s par rÃ©sidence
- Logs d'audit pour tentatives suspectes
- Protection contre l'escalade de privilÃ¨ges

**Interactions**:
- Interface avec `ResidenceContext` pour la sÃ©lection de rÃ©sidence
- Middleware d'authentification pour toutes les actions sensibles
- IntÃ©gration Microsoft Graph pour profils utilisateurs

---

### **2. Gestion Multi-RÃ©sidences**
ğŸ“ **Localisation**: `src/context/ResidenceContext.js`, `src/userResidenceMapping.js`

**Fonctionnement**:
- SystÃ¨me de mapping email â†’ rÃ©sidences autorisÃ©es
- SÃ©lection de rÃ©sidence active
- Publication ciblÃ©e multi-rÃ©sidences
- Filtrage automatique par rÃ©sidence

**Composants ClÃ©s**:
- `ResidenceTagSelector`: SÃ©lection multi-rÃ©sidences avec validation
- `ResidenceSelector`: Changement de rÃ©sidence active
- `ResidenceMultiSelector`: Interface pour publications

**DÃ©pendances**:
- Requiert authentification prÃ©alable
- SynchronisÃ© avec le contexte d'authentification
- Valide les permissions utilisateur

---

### **3. SystÃ¨me de Publication UnifiÃ©**
ğŸ“ **Localisation**: `src/components/ModalPublicationForm.js`

**Types de Publications**:
1. **Posts** - Articles et informations gÃ©nÃ©rales
2. **Events** - Ã‰vÃ©nements avec calendrier intÃ©grÃ©
3. **Polls** - Sondages avec choix multiples
4. **Alerts** - Alertes urgentes
5. **Daily Messages** - Messages quotidiens

**FonctionnalitÃ©s**:
- Interface unifiÃ©e pour tous types
- Ã‰diteur WYSIWYG intÃ©grÃ©
- Publication immÃ©diate ou programmÃ©e
- AperÃ§u mobile en temps rÃ©el
- Validation multi-niveaux

**Workflow**:
1. SÃ©lection des rÃ©sidences cibles (sÃ©curisÃ©e)
2. Saisie du contenu avec validation
3. AperÃ§u optionnel
4. Publication ou sauvegarde en brouillon

---

### **4. Dashboard Analytics**
ğŸ“ **Localisation**: `src/pages/Dashboard.js`

**MÃ©triques AffichÃ©es**:
- Statistiques de publication par type
- ActivitÃ© rÃ©cente
- Actions rapides
- Tendances par rÃ©sidence

**Widgets**:
- Cartes statistiques avec tendances
- Timeline d'activitÃ© rÃ©cente
- Boutons d'actions rapides
- Graphiques de performance

---

### **5. Calendrier IntÃ©grÃ©**
ğŸ“ **Localisation**: `src/pages/EventsCalendar.js`

**FonctionnalitÃ©s**:
- Vue mensuelle/hebdomadaire/quotidienne
- Filtrage par rÃ©sidence
- CrÃ©ation d'Ã©vÃ©nements par glisser-dÃ©poser
- Gestion des participants
- Export iCal

**IntÃ©grations**:
- SynchronisÃ© avec la gestion d'Ã©vÃ©nements
- Filtres dynamiques par rÃ©sidence
- Interface responsive

---

## ğŸ”§ **Composants Techniques**

### **Gestion d'Erreurs Robuste**
ğŸ“ **Localisation**: `src/utils/errorHandler.js`

**FonctionnalitÃ©s**:
- Retry automatique avec backoff exponentiel
- Sauvegarde locale en cas d'Ã©chec
- Messages d'erreur contextuels
- Logs dÃ©taillÃ©s pour debugging

### **SystÃ¨me de Logs**
ğŸ“ **Localisation**: `src/utils/publicationLogger.js`

**CapacitÃ©s**:
- Logging complet des publications
- TraÃ§abilitÃ© des actions utilisateur
- MÃ©triques de performance
- Audit de sÃ©curitÃ©

### **Composants UI RÃ©utilisables**
- `DataTable`: Table avec tri, recherche, pagination
- `PageHeader`: En-tÃªtes de pages avec breadcrumbs
- `RichTextEditor`: Ã‰diteur WYSIWYG personnalisÃ©
- `MobilePreview`: AperÃ§u mobile des publications

---

## ğŸ” **SÃ©curitÃ© et Validation**

### **Niveaux de SÃ©curitÃ©**
1. **Authentification prÃ©alable** - VÃ©rification MSAL
2. **Autorisation rÃ©sidence** - Mapping utilisateur-rÃ©sidences
3. **Validation interface** - ContrÃ´les client-side
4. **Validation dynamique** - VÃ©rifications temps rÃ©el
5. **Validation finale** - Double contrÃ´le avant soumission

### **SchÃ©mas de Validation**
ğŸ“ **Localisation**: `schemas/`
- JSON Schema pour chaque type de publication
- Validation cÃ´tÃ© client et prÃ©paration serveur
- Contraintes de sÃ©curitÃ© intÃ©grÃ©es

---

## ğŸ—ï¸ **Base de DonnÃ©es**

### **Architecture PostgreSQL**
ğŸ“ **Localisation**: `schemas/creation.sql`

**Tables Principales**:
- `posts`, `events`, `polls`, `alerts`, `daily_messages`
- `user_profiles`, `event_participants`
- `post_reactions`, `poll_votes`
- SystÃ¨me de vues et statistiques en cache

**Optimisations**:
- Index partiels pour performance
- Triggers pour mise Ã  jour automatique
- Fonctions PL/pgSQL pour requÃªtes complexes
- Cache matÃ©rialisÃ© pour analytics

---

## ğŸ”„ **Flux de DonnÃ©es**

### **Cycle de Vie d'une Publication**
1. **Authentification** â†’ VÃ©rification utilisateur
2. **SÃ©lection RÃ©sidences** â†’ Validation autorisations
3. **Saisie Contenu** â†’ Validation formulaire
4. **PrÃ©visualisation** â†’ GÃ©nÃ©ration aperÃ§u
5. **Publication** â†’ Sauvegarde + Logs
6. **Distribution** â†’ Filtrage par rÃ©sidence

### **Interactions Composants**
```
AuthContext â†â†’ ResidenceContext
     â†“              â†“
   useAuth â†â†’ useResidence
     â†“              â†“
ModalPublicationForm â†â†’ ResidenceTagSelector
     â†“
PublicationLogger + ErrorHandler
```

---

## ğŸš€ **Extensions PrÃ©vues**

### **âœ… RÃ©cemment ImplÃ©mentÃ©**
- **Contexte de Publications Persistant** : Sauvegarde automatique locale + sync serveur transparente
- **Auto-sauvegarde des Brouillons** : Restauration automatique aprÃ¨s 24h
- **Mode Hors-ligne Intelligent** : CrÃ©ation continue mÃªme sans connexion
- **Gestion d'Images Hybride** : Upload de fichier OU URL au choix
- **Interface Date/Heure SimplifiÃ©e** : Un seul champ daterange pour les Ã©vÃ©nements
- **Gestion ComplÃ¨te des Sondages** : RÃ©ponses multiples, Ã©chÃ©ances, images

### **Court Terme**
- Validation serveur (actuellement client-side uniquement)
- API REST complÃ¨te
- Synchronisation automatique en arriÃ¨re-plan

### **Moyen Terme**
- Notifications push
- Templates de publication
- Workflow d'approbation

### **Long Terme**
- Analytics avancÃ©s
- IA pour suggestion de contenu
- Application mobile native

---

## ğŸ“Š **MÃ©triques et Monitoring**

### **Performance**
- Temps de chargement des pages
- Taux de rÃ©ussite des publications
- MÃ©triques d'engagement utilisateur

### **SÃ©curitÃ©**
- Tentatives d'accÃ¨s non autorisÃ©es
- Ã‰checs d'authentification
- Violations de permissions

---

## ğŸ› ï¸ **Maintenance**

### **Logs Ã  Surveiller**
- Erreurs d'authentification MSAL
- Ã‰checs de publication
- Tentatives de sÃ©lection non autorisÃ©e

### **Mises Ã  Jour RÃ©guliÃ¨res**
- Tokens Azure AD
- SchÃ©mas de validation
- Mapping utilisateur-rÃ©sidences

### **Sauvegarde**
- Publications Ã©chouÃ©es (localStorage)
- Sessions utilisateur
- Configuration rÃ©sidences

---

## ğŸ“ **Notes Techniques**

### **CompatibilitÃ©**
- React 18+ requis
- Material-UI v7 (derniÃ¨re version)
- Node.js 16+ recommandÃ©

### **Configuration**
- Variables d'environnement pour Azure AD
- Mapping rÃ©sidences dans `userResidenceMapping.js`
- ThÃ¨mes CSS dans `src/styles/directus-theme.css`

### **Tests**
- Tests unitaires avec Jest
- Tests de sÃ©curitÃ© automatisÃ©s
- Validation des schÃ©mas JSON

---

## ğŸ” **Points d'Attention**

### **SÃ©curitÃ© Critique**
- Toujours valider les rÃ©sidences sÃ©lectionnÃ©es
- Ne jamais faire confiance aux donnÃ©es client-side
- Logger toutes les actions sensibles

### **Performance**
- Optimiser les re-renders React
- Utiliser la pagination pour grandes listes
- Cache les donnÃ©es statiques

### **UX/UI**
- Interface responsive obligatoire
- Feedback utilisateur pour toutes actions
- Messages d'erreur comprÃ©hensibles

---

---

## ğŸ‰ **DerniÃ¨res AmÃ©liorations - Version 0.2.0**

### **ğŸ”„ Persistance Robuste (NOUVEAU)**
- **PublicationsContext** : SystÃ¨me hybride local + serveur
- **Auto-sauvegarde** : Brouillons sauvÃ©s automatiquement pendant la saisie
- **Mode hors-ligne** : Fonctionnement complet sans connexion
- **Synchronisation transparente** : Invisible pour l'utilisateur mÃ©tier

### **ğŸ–¼ï¸ Gestion d'Images AmÃ©liorÃ©e (NOUVEAU)**
- **Type 'image'** : Upload de fichier OU saisie d'URL au choix
- **AperÃ§u instantanÃ©** : Visualisation immÃ©diate de l'image sÃ©lectionnÃ©e
- **Validation automatique** : VÃ©rification du format et affichage

### **ğŸ“… Interface Ã‰vÃ©nements SimplifiÃ©e (NOUVEAU)**
- **Type 'daterange'** : Remplacement de 3 champs par 1 seul
- **Validation intelligente** : Date de fin automatiquement aprÃ¨s dÃ©but
- **UX amÃ©liorÃ©e** : Plus simple et intuitif pour l'utilisateur

### **ğŸ“Š Sondages Complets (CORRIGÃ‰)**
- **Type 'pollAnswers'** : Gestion complÃ¨te des rÃ©ponses multiples
- **Conditions dynamiques** : Champs qui apparaissent selon les choix
- **Validation robuste** : Minimum 2 rÃ©ponses requises

---

**DerniÃ¨re mise Ã  jour**: DÃ©cembre 2024  
**Version**: 0.2.0  
**Mainteneur**: Ã‰quipe UXCO
